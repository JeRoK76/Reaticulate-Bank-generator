<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reaticulate Custom Bank Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #222;
            /* Darker mode background */
            color: #fff;
            /* Dark mode text color */
            max-width: 800px;
            /* Narrower page */
            margin: 0 auto;
        }

        input,
        select,
        textarea,
        button {
            display: block;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #444;
            color: #fff;
            width: 100%;
        }

        textarea {
            resize: none;
        }

        button {
            background-color: #555;
            border: none;
            cursor: pointer;
            width: auto;
        }

        button:hover {
            background-color: #666;
        }

        .articulation {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            background-color: #444;
            /* Dark mode articulation background */
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 5px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            left: 105%;
            /* Position the tooltip to the right */
            top: 50%;
            margin-left: 10px;
            margin-top: -20px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .key-switch-container {
            display: flex;
            align-items: center;
        }

        .key-switch-container input,
        .key-switch-container select {
            margin-right: 10px;
        }

        .articulation-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .color-picker-box {
            width: 50px;
            /* Wider color picker box */
            height: 30px;
            border: 1px solid #ccc;
            display: inline-block;
            cursor: pointer;
            margin-right: 10px;
        }

        .btn-container {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            /* Small space between buttons */
        }

        h1,
        h2 {
            text-align: center;
        }
    </style>
</head>

<body>
    <h1>Reaticulate Custom Bank Generator</h1>
    <label for="group">Group:</label>
    <input type="text" id="group" placeholder="e.g. Spitfire/Symphonic Brass">

    <label for="patch">Patch Name:</label>
    <input type="text" id="patch" placeholder="e.g. Horn Solo">

    <label for="uacc" class="tooltip">Set UACC (Yes/No):
        <span class="tooltiptext">Use UACC for Spitfire Audio orchestral libraries for standardized articulation
            control.</span>
    </label>
    <select id="uacc">
        <option value="no">No</option>
        <option value="yes">Yes</option>
    </select>

    <div class="btn-container">
        <button onclick="addArticulation()">Add Articulation</button>
        <button onclick="addSpacer()">Add Spacer</button>
    </div>

    <div id="articulations"></div>

    <div style="margin-top: 20px;">
        <button onclick="generateBank()">Generate Bank</button>
    </div>

    <h2>Generated Bank</h2>
    <textarea id="output" rows="20" cols="80" readonly></textarea>
    <div class="btn-container" style="margin-top: 10px;">
        <button onclick="copyToClipboard()">Copy to Clipboard</button>
        <button onclick="saveAsText()">Save as Text File</button>
    </div>

    <script>
        let articulationCount = 0;
        let lastKeySwitch = 24; // Starting at C-1 (MIDI note number 24)
        let usedProgramNumbers = new Set();

        const categories = [
            {
                name: "legato",
                icon: "legato",
                output: "cc:32,20",
                program: 20,
                displayName: "legato normale"
            },
            {
                name: "long",
                icon: "note-whole",
                output: "cc:32,1",
                program: 1,
                displayName: "long normale / sustain (chords)"
            },
            {
                name: "short",
                icon: "marcato-quarter",
                output: "cc:32,52",
                program: 52,
                displayName: "short hard (e.g. marcato short or staccato dig)"
            },
            {
                name: "short-dark",
                icon: "rip",
                output: "cc:32,100",
                program: 100,
                displayName: "rip"
            },
            {
                name: "long-dark",
                icon: "tremolo",
                output: "cc:32,70",
                program: 70,
                displayName: "trill minor 2"
            },
            {
                name: "fx",
                icon: "fx",
                output: "cc:32,71",
                program: 71,
                displayName: "trill major 2"
            }
        ];

        const icons = {
            general: [
                "accented-half", "accented-quarter", "acciaccatura-quarter", "alt-circle", "alt-gypsy",
                "alt-gypsy-eighth", "alt-gypsy-harmonics", "alt-tremolo-gypsy-harmonics", "alt-wave",
                "alt-wave-double", "alt-wave-double-stopped", "alt-wave-double-tr", "alt-x", "bend-down",
                "bend-up", "blend", "bow-down", "bow-up", "col-legno", "col-legno-whole"
            ],
            conSord: [
                "con-sord", "con-sord-blend", "con-sord-bow-down", "con-sord-bow-up", "con-sord-sul-pont",
                "con-sord-sul-pont-bow-up"
            ],
            cresc: [
                "cresc-f-half", "cresc-half", "cresc-m-half", "cresc-mf-half", "cresc-mp-half",
                "cresc-p-half", "cresc-quarter", "crescendo"
            ],
            fx: [
                "cuivre", "dblstop-5th", "dblstop-5th-eighth", "decrescendo", "fall", "fanfare", "flautando",
                "flautando-con-sord", "flautando-con-sord-eighth", "fortepiano", "fx", "ghost-eighth"
            ],
            harmonics: [
                "harmonics", "harmonics-natural", "harmonics-natural-eighth", "harp-pdlt", "harp-pdlt2"
            ],
            legato: [
                "legato", "legato-blend-generic", "legato-bowed", "legato-bowed2", "legato-con-sord",
                "legato-fast", "legato-flautando", "legato-gliss", "legato-portamento", "legato-portamento-con-sord",
                "legato-portamento-flautando", "legato-runs", "legato-slow", "legato-slow-blend", "legato-sul-c",
                "legato-sul-g", "legato-sul-pont", "legato-tremolo", "legato-vibrato"
            ],
            note: [
                "light", "list", "marcato-half", "marcato-quarter", "multitongued", "note-acciaccatura",
                "note-eighth", "note-half", "note-quarter", "note-sixteenth", "note-tied", "note-whole"
            ],
            phrase: [
                "phrase", "phrase-multitongued", "phrase-multitongued-cresc", "phrase2"
            ],
            pizz: [
                "pizz", "pizz-bartok", "pizz-con-sord", "pizz-mix", "pizz-sul-pont"
            ],
            portato: [
                "plop", "portato", "rest-quarter", "ricochet", "rip", "run-major", "run-minor", "scoop", "sfz"
            ],
            spiccato: [
                "spiccato", "spiccato-breath", "spiccato-brushed", "spiccato-brushed-con-sord",
                "spiccato-brushed-con-sord-sul-pont", "spiccato-feathered"
            ],
            staccato: [
                "staccatissimo-stopped", "staccato", "staccato-breath", "staccato-con-sord", "staccato-dig",
                "staccato-harmonics", "staccato-harmonics-half", "staccato-sfz", "staccato-stopped"
            ],
            sul: [
                "stopped", "sul-c", "sul-g", "sul-pont", "sul-tasto", "sul-tasto-super", "sul-tasto-super-eighth"
            ],
            tenuto: [
                "tenuto-eighth", "tenuto-half", "tenuto-quarter"
            ],
            tremolo: [
                "tremolo", "tremolo-con-sord", "tremolo-con-sord-sul-pont", "tremolo-fingered", "tremolo-ghost",
                "tremolo-harmonics", "tremolo-harmonics-a", "tremolo-harmonics-b", "tremolo-measured-eighth",
                "tremolo-measured-eighth-con-sord", "tremolo-measured-sixteenth", "tremolo-measured-sixteenth-con-sord",
                "tremolo-slurred", "tremolo-sul-pont"
            ],
            trill: [
                "trill", "trill-maj2", "trill-maj3", "trill-min2", "trill-min3", "trill-perf4"
            ],
            vibrato: [
                "vibrato", "vibrato-con-sord", "vibrato-molto"
            ]
        };

        const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

        function midiNoteToName(note) {
            const octave = Math.floor(note / 12) - 2;
            const noteName = noteNames[note % 12];
            return `${noteName}${octave}`;
        }

        function nameToMidiNote(name) {
            const regex = /^([A-G]#?)(-?\d)$/;
            const match = name.match(regex);
            if (match) {
                const note = noteNames.indexOf(match[1]);
                const octave = parseInt(match[2]);
                return (octave + 2) * 12 + note;
            }
            return null;
        }

        function generateNoteOptions() {
            let options = "";
            for (let i = 0; i <= 127; i++) {
                const noteName = midiNoteToName(i);
                options += `<option value="${noteName}">${noteName} (${i})</option>`;
            }
            return options;
        }

        function generateIconOptions() {
            let options = "";
            for (const category in icons) {
                options += `<optgroup label="${category}">`;
                icons[category].forEach(icon => {
                    options += `<option value="${icon}">${icon}</option>`;
                });
                options += `</optgroup>`;
            }
            return options;
        }

        function addArticulation() {
            articulationCount++;
            let programNumber = findNextProgramNumber();
            usedProgramNumbers.add(programNumber);

            const div = document.createElement('div');
            div.classList.add('articulation');
            div.innerHTML = `
                <div class="articulation-title">
                    <h3 id="articulation-title-${articulationCount}">Articulation ${articulationCount}</h3>
                    <button onclick="toggleArticulation(${articulationCount})">▼</button>
                </div>
                <div id="articulation-content-${articulationCount}">
                    <label for="articulation-${articulationCount}-category">Category:</label>
                    <select id="articulation-${articulationCount}-category" onchange="updateArticulation(${articulationCount})">
                        ${categories.map(category => `<option value="${category.name}">${category.name}</option>`).join('')}
                    </select>
                    
                    <label for="articulation-${articulationCount}-icon">Icon:</label>
                    <select id="articulation-${articulationCount}-icon">
                        ${generateIconOptions()}
                    </select>
                    
                    <label for="articulation-${articulationCount}-output">Output:</label>
                    <select id="articulation-${articulationCount}-output">
                        ${categories.map(category => `<option value="${category.output}">${category.output}</option>`).join('')}
                    </select>
                    
                    <label for="articulation-${articulationCount}-program" class="tooltip">Program Number:
                        <span class="tooltiptext">Program Number: A unique number for each articulation. You can set it to any number you like or leave it as is.</span>
                    </label>
                    <input type="number" id="articulation-${articulationCount}-program" value="${programNumber}" style="width: calc(100% - 22px);">
                    
                    <label for="articulation-${articulationCount}-name" class="tooltip">Name:
                        <span class="tooltiptext">Name: A descriptive name for the articulation. You can set it to anything you like or leave it as is.</span>
                    </label>
                    <input type="text" id="articulation-${articulationCount}-name" value="" placeholder="Enter articulation name" oninput="updateArticulationTitle(${articulationCount})" style="width: calc(100% - 22px);">
                    
                    <label for="articulation-${articulationCount}-key-switch-name" class="tooltip">Key Switch (MIDI Note Name):
                        <span class="tooltiptext">Enter a MIDI note name (e.g., C-2). The next articulation will automatically increment.</span>
                    </label>
                    <select id="articulation-${articulationCount}-key-switch-name" oninput="updateKeySwitchFromName(${articulationCount})">
                        ${generateNoteOptions()}
                    </select>
                    
                    <label for="articulation-${articulationCount}-color">Color:</label>
                    <div class="color-picker-box" id="color-box-${articulationCount}" onclick="openColorPicker(${articulationCount})" style="background-color: #ff0000;"></div>
                    <input type="color" id="articulation-${articulationCount}-color" value="#ff0000" oninput="updateColorCode(${articulationCount})" style="display: none;">
                    <span id="articulation-${articulationCount}-color-code" style="display: block; margin-top: 10px;">#ff0000</span> <!-- Hex color code below the box -->
                </div>
            `;
            document.getElementById('articulations').appendChild(div);
            lastKeySwitch++;
        }

        function findNextProgramNumber() {
            let programNumber;
            do {
                programNumber = (articulationCount % 127) + 1;
                articulationCount++;
            } while (usedProgramNumbers.has(programNumber));
            return programNumber;
        }

        function updateArticulation(index) {
            const categoryValue = document.getElementById(`articulation-${index}-category`).value;
            const category = categories.find(cat => cat.name === categoryValue);
            document.getElementById(`articulation-${index}-icon`).value = category.icon;
            document.getElementById(`articulation-${index}-output`).value = category.output;
            document.getElementById(`articulation-${index}-program`).value = category.program;
        }

        function updateKeySwitch(index) {
            const keySwitchNumber = document.getElementById(`articulation-${index}-key-switch-number`).value;
            document.getElementById(`articulation-${index}-key-switch-name`).value = midiNoteToName(keySwitchNumber);
        }

        function updateKeySwitchFromName(index) {
            const keySwitchName = document.getElementById(`articulation-${index}-key-switch-name`).value;
            const midiNote = nameToMidiNote(keySwitchName);
            if (midiNote !== null) {
                document.getElementById(`articulation-${index}-key-switch-number`).value = midiNote;
            }
        }

        function updateColorCode(index) {
            const colorValue = document.getElementById(`articulation-${index}-color`).value;
            document.getElementById(`color-box-${index}`).style.backgroundColor = colorValue;
            document.getElementById(`articulation-${index}-color-code`).innerText = colorValue;
        }

        function openColorPicker(index) {
            const colorInput = document.getElementById(`articulation-${index}-color`);
            colorInput.click();
            colorInput.addEventListener('input', () => {
                updateColorCode(index);
            });
        }

        function addSpacer() {
            articulationCount++;
            const div = document.createElement('div');
            div.classList.add('articulation');
            div.innerHTML = `
                <h3>Spacer</h3>
                <label for="spacer-${articulationCount}-size">Size:</label>
                <input type="number" id="spacer-${articulationCount}-size" value="1" style="width: auto;">
            `;
            document.getElementById('articulations').appendChild(div);
        }

        function toggleArticulation(index) {
            const content = document.getElementById(`articulation-content-${index}`);
            const button = content.previousElementSibling.querySelector('button');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                button.textContent = '▼';
            } else {
                content.style.display = 'none';
                button.textContent = '►';
            }
        }

        function updateArticulationTitle(index) {
            const nameValue = document.getElementById(`articulation-${index}-name`).value;
            document.getElementById(`articulation-title-${index}`).innerText = nameValue || `Articulation ${index}`;
        }

        function generateBank() {
            const group = document.getElementById('group').value;
            const patch = document.getElementById('patch').value;
            const uacc = document.getElementById('uacc').value === 'yes' ? 'Set patch to UACC' : '';
            const id = generateUUID();

            let bankText = `//! g="${group}" n="${patch}"\n`;
            if (uacc) {
                bankText += `//! m="${uacc}"\n`;
            }
            bankText += `//! id=${id}\n`;
            bankText += `Bank * * ${patch}\n`;

            for (let i = 1; i <= articulationCount; i++) {
                const category = document.getElementById(`articulation-${i}-category`)?.value;
                if (category) {
                    const icon = document.getElementById(`articulation-${i}-icon`).value;
                    const output = document.getElementById(`articulation-${i}-output`).value;
                    const program = document.getElementById(`articulation-${i}-program`).value;
                    const name = document.getElementById(`articulation-${i}-name`).value;
                    const keySwitchValue = document.getElementById(`articulation-${i}-key-switch-name`).value;
                    const color = document.getElementById(`articulation-${i}-color`).value;

                    bankText += `//! c=${category} i=${icon} o=note:${keySwitchValue}/cc:32,${output.split(':')[1]} c=${color}\n`;
                    bankText += `${program} ${name}\n`;
                } else {
                    const spacerSize = document.getElementById(`spacer-${i}-size`)?.value;
                    if (spacerSize) {
                        bankText += `//! spacer=${spacerSize}\n`;
                    }
                }
            }

            document.getElementById('output').value = bankText;
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0,
                    v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function copyToClipboard() {
            const output = document.getElementById('output');
            output.select();
            document.execCommand('copy');
            alert('Copied to clipboard');
        }

        function saveAsText() {
            const output = document.getElementById('output').value;
            const blob = new Blob([output], {
                type: 'text/plain'
            });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'custom_bank.reabank';
            a.click();
            URL.revokeObjectURL(a.href);
        }
    </script>
</body>

</html>
